<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Chat - P2PåŠ å¯†èŠå¤©ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background-color: #0f172a; 
            color: #f8fafc; 
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .chat-gradient { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
        }
        .danger-gradient {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .success-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            word-break: break-word;
        }
        .message-bubble.own {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message-bubble.other {
            background: rgba(30, 41, 59, 0.8);
            color: #f8fafc;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message-bubble.system {
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            margin: 0 auto;
            max-width: 90%;
            font-size: 0.9em;
            text-align: center;
        }
        
        /* åœ¨çº¿ç”¨æˆ·çŠ¶æ€ */
        .online-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .offline-dot {
            width: 8px;
            height: 8px;
            background: #64748b;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 320px;
            animation: fadeIn 0.2s ease-out;
        }
        
        /* è¡¨æƒ…é€‰æ‹©å™¨ */
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1001;
            display: none;
        }
        
        .emoji-picker.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        
        .emoji-category {
            margin-bottom: 16px;
        }
        
        .emoji-category-title {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }
        
        .emoji-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .emoji-item:hover {
            background: rgba(255,255,255,0.1);
            transform: scale(1.1);
        }
        
        /* æ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡† */
        .file-upload-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 1000;
            width: 400px;
            animation: fadeIn 0.2s ease-out;
        }
        
        .file-drop-area {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .file-drop-area:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .file-drop-area.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .file-preview {
            margin-top: 16px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .file-size {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .file-remove {
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
        }
        
        /* æ–‡ä»¶æ¶ˆæ¯æ ·å¼ */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            margin-top: 8px;
        }
        
        .file-message .file-icon {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        
        .file-message .file-details {
            flex: 1;
        }
        
        .file-message .file-name {
            font-size: 13px;
            margin-bottom: 2px;
        }
        
        .file-message .file-size {
            font-size: 11px;
        }
        
        .file-download-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .file-download-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <nav class="w-20 flex flex-col items-center py-6 glass border-r border-slate-700">
        <div class="w-12 h-12 chat-gradient rounded-2xl flex items-center justify-center mb-10 shadow-lg shadow-blue-500/20">
            <i class="fas fa-lock text-xl"></i>
        </div>
        <div class="space-y-8 flex-1">
            <i class="fas fa-comment-dots text-xl text-blue-400 cursor-pointer" title="å…¬å…±èŠå¤©"></i>
            <i class="fas fa-users text-xl text-slate-400 hover:text-white transition cursor-pointer" title="åœ¨çº¿ç”¨æˆ·"></i>
            <i class="fas fa-shield-alt text-xl text-slate-400 hover:text-white transition cursor-pointer" title="åŠ å¯†è®¾ç½®"></i>
        </div>
        <i class="fas fa-cog text-xl text-slate-400 hover:text-white transition cursor-pointer" title="è®¾ç½®"></i>
    </nav>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-section" class="flex-1 flex flex-col items-center justify-center p-8">
        <div class="glass rounded-3xl p-10 max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 chat-gradient rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/20">
                    <i class="fas fa-lock text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Aurora Chat</h1>
                <p class="text-slate-400">ç«¯åˆ°ç«¯åŠ å¯† Â· çœŸäººå¯¹çœŸäºº Â· å®‰å…¨é€šä¿¡</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å" 
                           class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-3 px-4 focus:outline-none focus:border-blue-500 transition text-white placeholder-slate-500">
                </div>
                
                <button id="login-btn" class="w-full chat-gradient text-white font-semibold py-3 rounded-xl hover:opacity-90 transition shadow-lg shadow-blue-500/20">
                    è¿›å…¥èŠå¤©å®¤
                </button>
                
                <div id="login-error" class="danger-gradient text-white p-3 rounded-xl text-sm hidden"></div>
                <div id="login-success" class="success-gradient text-white p-3 rounded-xl text-sm hidden"></div>
                
                <div class="text-center text-slate-500 text-sm pt-4 border-t border-slate-800">
                    <p>ç³»ç»ŸçŠ¶æ€: <span id="backend-status" class="text-red-400">æ£€æŸ¥ä¸­...</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¬å…±èŠå¤©ç•Œé¢ -->
    <div id="chat-section" class="flex-1 flex flex-col hidden">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="h-20 glass flex items-center justify-between px-8 border-b border-slate-700/50">
            <div class="flex items-center">
                <div class="w-10 h-10 chat-gradient rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <div class="ml-4">
                    <h3 class="font-bold text-sm" id="current-user">æœªç™»å½•</h3>
                    <div class="flex items-center">
                        <span class="online-dot"></span>
                        <span class="text-xs text-green-500">åœ¨çº¿</span>
                        <span class="text-xs text-slate-500 ml-2">ç”¨æˆ·æ•°: <span id="online-count">0</span></span>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button id="refresh-users-btn" class="glass px-4 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                    <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°åˆ—è¡¨
                </button>
                <button id="logout-btn" class="danger-gradient px-4 py-2 rounded-xl text-sm hover:opacity-90 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>é€€å‡ºç™»å½•
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- å·¦ä¾§ï¼šåœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
            <aside class="w-80 glass flex flex-col border-r border-slate-700">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">åœ¨çº¿ç”¨æˆ·</h2>
                    <div class="relative mb-4">
                        <input type="text" placeholder="æœç´¢ç”¨æˆ·..." 
                               class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-2 pl-10 pr-4 focus:outline-none focus:border-blue-500 transition text-white placeholder-slate-500">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-sm"></i>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto px-3 pb-6">
                    <div id="online-users-list" class="space-y-2">
                        <!-- åœ¨çº¿ç”¨æˆ·å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        <div class="text-center text-slate-500 py-8">
                            <i class="fas fa-users text-2xl mb-2"></i>
                            <p>æš‚æ— åœ¨çº¿ç”¨æˆ·</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-slate-800/30 rounded-xl">
                        <h4 class="font-semibold text-sm mb-3">P2Pè¿æ¥</h4>
                        <div class="space-y-3">
                            <input type="text" id="connect-username" placeholder="è¾“å…¥ç”¨æˆ·å" 
                                   class="w-full bg-slate-800/50 border border-slate-700 rounded-xl py-2 px-4 focus:outline-none focus:border-blue-500 transition text-white placeholder-slate-500 text-sm">
                            <button id="connect-btn" class="w-full success-gradient text-white font-semibold py-2 rounded-xl hover:opacity-90 transition text-sm">
                                <i class="fas fa-link mr-2"></i>å»ºç«‹P2Pè¿æ¥
                            </button>
                            <div id="connection-status" class="text-xs text-slate-400 mt-2">
                                <i class="fas fa-plug mr-1"></i>æœªè¿æ¥
                            </div>
                        </div>
                        
                        <!-- P2PèŠå¤©ä¼šè¯ç®¡ç† -->
                        <div id="p2p-sessions-section" class="mt-4 pt-4 border-t border-slate-700/50 hidden">
                            <h5 class="font-semibold text-xs mb-2 text-slate-400">æˆ‘çš„P2PèŠå¤©</h5>
                            <div id="p2p-sessions-list" class="space-y-2">
                                <!-- P2Pä¼šè¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- å³ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
            <main class="flex-1 flex flex-col">
                <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                <section class="flex-1 overflow-y-auto p-6 space-y-4" id="chat-messages">
                    <div class="message-bubble system fade-in">
                        <div class="flex items-center justify-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span>æ¬¢è¿æ¥åˆ°Aurora Chatï¼è¯·ç™»å½•å¼€å§‹çœŸæ­£çš„ç”¨æˆ·é—´é€šä¿¡ã€‚</span>
                        </div>
                    </div>
                </section>

                <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
                <footer class="p-6 border-t border-slate-700/50">
                    <div class="glass max-w-4xl mx-auto rounded-2xl flex items-center px-4 py-2 shadow-2xl">
                        <button class="p-2 text-slate-400 hover:text-white transition">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled
                               class="flex-1 bg-transparent border-none focus:outline-none px-4 text-sm py-3 text-white placeholder-slate-500">
                        <button class="p-2 text-slate-400 hover:text-white mx-2 transition">
                            <i class="far fa-smile"></i>
                        </button>
                        <button id="send-btn" disabled
                                class="chat-gradient w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <!-- æ·»åŠ Socket.IOå®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // ç³»ç»Ÿé…ç½®
        const API_BASE_URL = window.location.origin; // ä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’ŒåŸŸå
        
        // ç³»ç»ŸçŠ¶æ€
        let currentUser = null;
        let socket = null;
        let onlineUsers = [];
        
        // è¿æ¥åˆ°Socket.IOæœåŠ¡å™¨
        function connectSocketIO() {
            if (socket) {
                socket.disconnect();
            }
            
            socket = io({
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            socket.on('connect', () => {
                console.log('Socket.IOè¿æ¥å·²å»ºç«‹');
                document.getElementById('backend-status').textContent = 'å·²è¿æ¥';
                document.getElementById('backend-status').className = 'text-green-400';
                
                addSystemMessage('WebSocketè¿æ¥æˆåŠŸï¼');
                
                // å¦‚æœå·²ç™»å½•ï¼Œé‡æ–°æ³¨å†Œç”¨æˆ·
                if (currentUser) {
                    registerUser(currentUser);
                }
            });
            
            socket.on('disconnect', () => {
                console.log('Socket.IOè¿æ¥å·²æ–­å¼€');
                document.getElementById('backend-status').textContent = 'æœªè¿æ¥';
                document.getElementById('backend-status').className = 'text-red-400';
                
                addSystemMessage('WebSocketè¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...');
            });
            
            socket.on('connect_error', (error) => {
                console.error('Socket.IOè¿æ¥é”™è¯¯:', error);
                addSystemMessage('WebSocketè¿æ¥é”™è¯¯: ' + error.message);
            });
            
            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            socket.on('registered', (data) => {
                console.log('ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:', data.username);
                addSystemMessage(`ç”¨æˆ· ${data.username} æ³¨å†ŒæˆåŠŸ`);
            });
            
            // ç›‘å¬æ³¨å†Œé”™è¯¯
            socket.on('register_error', (data) => {
                console.log('æ³¨å†Œé”™è¯¯:', data.error);
                const errorElement = document.getElementById('login-error');
                errorElement.textContent = data.error;
                errorElement.classList.remove('hidden');
                
                // é‡ç½®ç™»å½•çŠ¶æ€
                currentUser = null;
                document.getElementById('login-btn').disabled = false;
            });
            
            socket.on('message', (data) => {
                console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                addMessage(data.sender, data.content, false);
            });
            
            socket.on('p2p_message', (data) => {
                console.log('æ”¶åˆ°P2Pæ¶ˆæ¯:', data);
                addMessage(data.from, data.message, false);
            });
            
            socket.on('user_online', (data) => {
                console.log('ç”¨æˆ·ä¸Šçº¿:', data);
                handleUserOnline(data);
            });
            
            socket.on('online_users', (data) => {
                console.log('åœ¨çº¿ç”¨æˆ·åˆ—è¡¨:', data);
                onlineUsers = data;
                updateOnlineUsersCount();
                updateOnlineUsersList();
            });
            
            // ç›‘å¬ç”¨æˆ·ä¸‹çº¿äº‹ä»¶
            socket.on('user_offline', (data) => {
                console.log('ç”¨æˆ·ä¸‹çº¿:', data);
                const username = data.username;
                
                // ä»åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä¸­ç§»é™¤
                onlineUsers = onlineUsers.filter(user => user.username !== username);
                updateOnlineUsersCount();
                updateOnlineUsersList();
                
                addSystemMessage(`ç”¨æˆ· ${username} å·²ä¸‹çº¿`);
            });
            
            socket.on('p2p_info', (data) => {
                console.log('P2Pä¿¡æ¯:', data);
            });
            
            // ç›‘å¬P2Pè¿æ¥è¯·æ±‚å“åº”
            socket.on('p2p_connection_initiated', (data) => {
                console.log('P2Pè¿æ¥åˆå§‹åŒ–:', data);
                if (data.success) {
                    document.getElementById('connection-status').innerHTML = `<i class="fas fa-link mr-1"></i>å·²è¿æ¥åˆ° ${data.target}`;
                    document.getElementById('connection-status').className = 'text-xs text-green-400 mt-2';
                    
                    // æ£€æŸ¥æ¶ˆæ¯å†…å®¹ï¼Œåªæœ‰å½“è¿æ¥çœŸæ­£å»ºç«‹æ—¶æ‰è·³è½¬
                    const message = data.message || '';
                    if (message.includes('Connection accepted') || message.includes('Connected to')) {
                        addSystemMessage(`P2Pè¿æ¥å·²å»ºç«‹: ${data.target}`);
                        // åˆ‡æ¢åˆ°P2PèŠå¤©ç•Œé¢
                        switchToP2PChat(data.target);
                    } else if (message.includes('Connection request sent')) {
                        addSystemMessage(`è¿æ¥è¯·æ±‚å·²å‘é€ç»™ ${data.target}ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—...`);
                        // ä¸è·³è½¬ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—
                    } else {
                        addSystemMessage(`P2Pè¿æ¥çŠ¶æ€: ${message}`);
                    }
                } else {
                    document.getElementById('connection-status').innerHTML = `<i class="fas fa-unlink mr-1"></i>è¿æ¥å¤±è´¥`;
                    document.getElementById('connection-status').className = 'text-xs text-red-400 mt-2';
                    addSystemMessage(`P2Pè¿æ¥å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            });
            
            // ç›‘å¬P2PèŠå¤©æ¶ˆæ¯
            socket.on('p2p_chat_message_received', (data) => {
                console.log('æ”¶åˆ°P2PèŠå¤©æ¶ˆæ¯:', data);
                
                // æ£€æŸ¥æ˜¯å¦åŠ å¯†æ¶ˆæ¯
                if (data.encrypted && data.encrypted_content && data.session_key) {
                    console.log('æ”¶åˆ°åŠ å¯†æ¶ˆæ¯ï¼Œå¼€å§‹è§£å¯†...');
                    
                    // è§£å¯†æ¶ˆæ¯
                    decryptAndDisplayMessage(data);
                } else {
                    // æ£€æŸ¥æ˜¯å¦åœ¨P2PèŠå¤©ç•Œé¢
                    const p2pChatSection = document.getElementById('p2p-chat-section');
                    if (p2pChatSection) {
                        addP2PMessage(data.from, data.content, false);
                    } else {
                        // å¦‚æœä¸åœ¨P2PèŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                        addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„P2Pæ¶ˆæ¯: ${data.content}`);
                    }
                }
            });
            
            // è§£å¯†å¹¶æ˜¾ç¤ºæ¶ˆæ¯
            function decryptAndDisplayMessage(data) {
                console.log('è°ƒç”¨è§£å¯†API:', data);
                
                fetch(API_BASE_URL + '/api/p2p/chat/decrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_content: data.encrypted_content,
                        session_key: data.session_key
                    })
                })
                .then(response => response.json())
                .then(decryptData => {
                    console.log('è§£å¯†ç»“æœ:', decryptData);
                    
                    if (decryptData.success) {
                        const decryptedContent = decryptData.decrypted_content;
                        console.log('è§£å¯†æˆåŠŸ:', decryptedContent);
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨P2PèŠå¤©ç•Œé¢
                        const p2pChatSection = document.getElementById('p2p-chat-section');
                        if (p2pChatSection) {
                            addP2PMessage(data.from, `ğŸ”“ ${decryptedContent}`, false);
                            addSystemMessage('æ¶ˆæ¯å·²è§£å¯†');
                        } else {
                            // å¦‚æœä¸åœ¨P2PèŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                            addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„åŠ å¯†æ¶ˆæ¯: ${decryptedContent}`);
                        }
                    } else {
                        console.error('è§£å¯†å¤±è´¥:', decryptData.error);
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨P2PèŠå¤©ç•Œé¢
                        const p2pChatSection = document.getElementById('p2p-chat-section');
                        if (p2pChatSection) {
                            addP2PMessage('ç³»ç»Ÿ', `è§£å¯†å¤±è´¥: ${decryptData.error}`, false);
                            // æ˜¾ç¤ºåŸå§‹åŠ å¯†æ¶ˆæ¯
                            addP2PMessage(data.from, `ğŸ”’ [åŠ å¯†æ¶ˆæ¯]`, false);
                        } else {
                            addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„åŠ å¯†æ¶ˆæ¯ï¼Œä½†è§£å¯†å¤±è´¥: ${decryptData.error}`);
                        }
                    }
                })
                .catch(error => {
                    console.error('è§£å¯†APIè°ƒç”¨å¤±è´¥:', error);
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨P2PèŠå¤©ç•Œé¢
                    const p2pChatSection = document.getElementById('p2p-chat-section');
                    if (p2pChatSection) {
                        addP2PMessage('ç³»ç»Ÿ', `è§£å¯†APIé”™è¯¯: ${error.message}`, false);
                        // æ˜¾ç¤ºåŸå§‹åŠ å¯†æ¶ˆæ¯
                        addP2PMessage(data.from, `ğŸ”’ [åŠ å¯†æ¶ˆæ¯]`, false);
                    } else {
                        addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„åŠ å¯†æ¶ˆæ¯ï¼Œä½†è§£å¯†APIé”™è¯¯: ${error.message}`);
                    }
                });
            }
            
        // ç›‘å¬P2Pè¿æ¥è¯·æ±‚
        socket.on('p2p_connection_request', (data) => {
            console.log('ğŸ¯ æ”¶åˆ°P2Pè¿æ¥è¯·æ±‚:', data);
            const fromUser = data.from;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰P2PèŠå¤©ç•Œé¢
            const existingP2PChat = document.getElementById('p2p-chat-section');
            if (existingP2PChat) {
                // å¦‚æœå·²ç»åœ¨P2PèŠå¤©ä¸­ï¼Œè‡ªåŠ¨æ‹’ç»æ–°çš„è¿æ¥è¯·æ±‚
                console.log('âš ï¸ å·²åœ¨P2PèŠå¤©ä¸­ï¼Œè‡ªåŠ¨æ‹’ç»æ–°çš„è¿æ¥è¯·æ±‚');
                socket.emit('p2p_accept', {
                    from: fromUser,
                    accepted: false
                });
                
                addSystemMessage(`å·²åœ¨P2PèŠå¤©ä¸­ï¼Œè‡ªåŠ¨æ‹’ç» ${fromUser} çš„è¿æ¥è¯·æ±‚`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¡®è®¤å¯¹è¯æ¡†
            const existingDialog = document.querySelector('.confirm-dialog');
            if (existingDialog) {
                console.log('âš ï¸ å·²æœ‰ç¡®è®¤å¯¹è¯æ¡†ï¼Œè‡ªåŠ¨æ‹’ç»æ–°çš„è¿æ¥è¯·æ±‚');
                socket.emit('p2p_accept', {
                    from: fromUser,
                    accepted: false
                });
                
                addSystemMessage(`å·²æœ‰å¾…å¤„ç†çš„è¿æ¥è¯·æ±‚ï¼Œè‡ªåŠ¨æ‹’ç» ${fromUser} çš„è¿æ¥è¯·æ±‚`);
                return;
            }
            
            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${fromUser} çš„P2Pè¿æ¥è¯·æ±‚`);
            
            // åˆ›å»ºAuroraé£æ ¼ç¡®è®¤å¯¹è¯æ¡†
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog fade-in';
            
            confirmDialog.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-12 h-12 chat-gradient rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-link text-lg"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">P2Pè¿æ¥è¯·æ±‚</h3>
                    <p class="text-slate-400 text-sm">ç”¨æˆ· <span class="text-blue-400 font-semibold">${fromUser}</span> è¯·æ±‚ä¸æ‚¨å»ºç«‹P2Pè¿æ¥ã€‚</p>
                </div>
                <div class="flex justify-center space-x-3">
                    <button id="confirm-reject" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                        <i class="fas fa-times mr-2"></i>æ‹’ç»
                    </button>
                    <button id="confirm-accept" class="chat-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                        <i class="fas fa-check mr-2"></i>æ¥å—
                    </button>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('confirm-accept').addEventListener('click', function() {
                console.log('âœ… ç”¨æˆ·ç‚¹å‡»äº†æ¥å—');
                socket.emit('p2p_accept', {
                    from: fromUser,
                    accepted: true
                });
                
                addSystemMessage(`å·²æ¥å— ${fromUser} çš„P2Pè¿æ¥è¯·æ±‚`);
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirm-reject').addEventListener('click', function() {
                console.log('âŒ ç”¨æˆ·ç‚¹å‡»äº†æ‹’ç»');
                socket.emit('p2p_accept', {
                    from: fromUser,
                    accepted: false
                });
                
                addSystemMessage(`å·²æ‹’ç» ${fromUser} çš„P2Pè¿æ¥è¯·æ±‚`);
                document.body.removeChild(confirmDialog);
            });
            
            // æ·»åŠ ESCé”®å…³é—­åŠŸèƒ½
            const handleEscKey = (e) => {
                if (e.key === 'Escape') {
                    console.log('âŒ ç”¨æˆ·æŒ‰äº†ESCé”®ï¼Œæ‹’ç»è¿æ¥');
                    socket.emit('p2p_accept', {
                        from: fromUser,
                        accepted: false
                    });
                    
                    addSystemMessage(`å·²æ‹’ç» ${fromUser} çš„P2Pè¿æ¥è¯·æ±‚`);
                    document.body.removeChild(confirmDialog);
                    document.removeEventListener('keydown', handleEscKey);
                }
            };
            
            document.addEventListener('keydown', handleEscKey);
            
            // å¯¹è¯æ¡†å…³é—­æ—¶ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
            const originalRemoveChild = document.body.removeChild.bind(document.body);
            const wrappedRemoveChild = (child) => {
                if (child === confirmDialog) {
                    document.removeEventListener('keydown', handleEscKey);
                }
                return originalRemoveChild(child);
            };
            document.body.removeChild = wrappedRemoveChild;
        });
            
            // ç›‘å¬P2Pè¿æ¥æ–­å¼€é€šçŸ¥
            socket.on('p2p_connection_disconnected', (data) => {
                console.log('æ”¶åˆ°P2Pè¿æ¥æ–­å¼€é€šçŸ¥:', data);
                const fromUser = data.from;
                const message = data.message;
                
                addSystemMessage(message);
                
                // å¦‚æœå½“å‰åœ¨P2PèŠå¤©ç•Œé¢ï¼Œè‡ªåŠ¨è¿”å›åˆ°å…¬å…±èŠå¤©
                const p2pChatSection = document.getElementById('p2p-chat-section');
                if (p2pChatSection) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸æ–­å¼€è¿æ¥çš„ç”¨æˆ·èŠå¤©
                    // ä»æ ‡é¢˜ä¸­æå–å½“å‰èŠå¤©çš„ç›®æ ‡ç”¨æˆ·
                    const headerElement = p2pChatSection.querySelector('h3.font-bold');
                    if (headerElement) {
                        const match = headerElement.textContent.match(/ä¸ (.+?) å»ºç«‹/);
                        let targetUser = '';
                        if (match && match[1]) {
                            targetUser = match[1];
                        } else {
                            // å¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼
                            const text = headerElement.textContent;
                            const parts = text.split(' - ä¸ ');
                            if (parts.length > 1) {
                                targetUser = parts[1].trim();
                            }
                        }
                        
                        console.log(`æ–­å¼€è¿æ¥æ£€æŸ¥: å½“å‰èŠå¤©ç›®æ ‡ç”¨æˆ·=${targetUser}, æ–­å¼€è¿æ¥ç”¨æˆ·=${fromUser}`);
                        
                        if (targetUser === fromUser) {
                            p2pChatSection.remove();
                            document.getElementById('chat-section').classList.remove('hidden');
                            document.getElementById('chat-section').classList.add('flex');
                            document.getElementById('connection-status').innerHTML = `<i class="fas fa-plug mr-1"></i>æœªè¿æ¥`;
                            document.getElementById('connection-status').className = 'text-xs text-slate-400 mt-2';
                            addSystemMessage(`å¯¹æ–¹ ${fromUser} å·²æ–­å¼€P2Pè¿æ¥ï¼Œå·²è¿”å›å…¬å…±èŠå¤©å®¤`);
                        }
                    }
                }
            });
        }
        
        // æ³¨å†Œç”¨æˆ·åˆ°æœåŠ¡å™¨
        function registerUser(username) {
            if (!socket || !socket.connected) {
                console.error('æ— æ³•æ³¨å†Œç”¨æˆ·: Socket.IOæœªè¿æ¥');
                return false;
            }
            
            socket.emit('register', {
                username: username,
                publicKey: 'auto-generated-key',
                p2p_ip: window.location.hostname, // âœ… åŠ¨æ€è·å–å½“å‰åŸŸå/IP
                p2p_port: window.location.port || (window.location.protocol === 'https:' ? 443 : 80)
            });
            
            // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            setTimeout(() => {
                socket.emit('get_online_users', {});
            }, 1000);
            
            return true;
        }
        
        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
        function sendMessageToServer(content) {
            if (!socket || !socket.connected) {
                console.error('æ— æ³•å‘é€æ¶ˆæ¯: Socket.IOæœªè¿æ¥');
                return false;
            }
            
            socket.emit('message', {
                content: content,
                timestamp: new Date().toISOString()
            });
            
            return true;
        }
        
        // å¤„ç†ç”¨æˆ·ä¸Šçº¿
        function handleUserOnline(data) {
            const { username } = data;
            addSystemMessage(`ç”¨æˆ· ${username} å·²ä¸Šçº¿`);
            
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·è®¡æ•°
            updateOnlineUsersCount();
        }
        
        // æ›´æ–°åœ¨çº¿ç”¨æˆ·è®¡æ•°
        function updateOnlineUsersCount() {
            document.getElementById('online-count').textContent = onlineUsers.length;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–çŠ¶æ€æ›´æ–°
        }
        
        // ç™»å½•åŠŸèƒ½
        document.getElementById('login-btn').addEventListener('click', function() {
            const username = document.getElementById('username').value.trim();
            const errorElement = document.getElementById('login-error');
            const successElement = document.getElementById('login-success');
            
            // æ¸…é™¤ä¹‹å‰çš„æ¶ˆæ¯
            errorElement.classList.add('hidden');
            successElement.classList.add('hidden');
            
            if (!username) {
                errorElement.textContent = 'è¯·è¾“å…¥ç”¨æˆ·å';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (username.length < 2) {
                errorElement.textContent = 'ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦';
                errorElement.classList.remove('hidden');
                return;
            }
            
            // æ£€æŸ¥Socket.IOè¿æ¥
            if (!socket || !socket.connected) {
                errorElement.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...';
                errorElement.classList.remove('hidden');
                
                // å°è¯•é‡æ–°è¿æ¥
                connectSocketIO();
                
                // ç­‰å¾…è¿æ¥å»ºç«‹
                const checkConnection = setInterval(() => {
                    if (socket && socket.connected) {
                        clearInterval(checkConnection);
                        completeLogin(username, successElement);
                    }
                }, 100);
                
                // 5ç§’è¶…æ—¶
                setTimeout(() => {
                    clearInterval(checkConnection);
                    if (!socket || !socket.connected) {
                        errorElement.textContent = 'è¿æ¥æœåŠ¡å™¨è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                        errorElement.classList.remove('hidden');
                    }
                }, 5000);
            } else {
                completeLogin(username, successElement);
            }
        });
        
        function completeLogin(username, successElement) {
            currentUser = username;
            
            // æ³¨å†Œç”¨æˆ·åˆ°æœåŠ¡å™¨
            const registered = registerUser(username);
            if (!registered) {
                document.getElementById('login-error').textContent = 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
                document.getElementById('login-error').classList.remove('hidden');
                return;
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            successElement.textContent = `æ¬¢è¿ ${username}ï¼æ­£åœ¨è¿›å…¥èŠå¤©å®¤...`;
            successElement.classList.remove('hidden');
            
            // ç¦ç”¨ç™»å½•æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            document.getElementById('login-btn').disabled = true;
            
            // ç­‰å¾…æ³¨å†ŒæˆåŠŸäº‹ä»¶
            const registrationTimeout = setTimeout(() => {
                // å¦‚æœ3ç§’å†…æ²¡æœ‰æ”¶åˆ°æ³¨å†ŒæˆåŠŸäº‹ä»¶ï¼Œè®¤ä¸ºæ³¨å†Œå¤±è´¥
                document.getElementById('login-error').textContent = 'æ³¨å†Œè¶…æ—¶ï¼Œè¯·é‡è¯•';
                document.getElementById('login-error').classList.remove('hidden');
                successElement.classList.add('hidden');
                document.getElementById('login-btn').disabled = false;
                currentUser = null;
            }, 3000);
            
            // ç›‘å¬æ³¨å†ŒæˆåŠŸäº‹ä»¶
            const handleRegistered = (data) => {
                if (data.username === username) {
                    clearTimeout(registrationTimeout);
                    socket.off('registered', handleRegistered);
                    
                    // å»¶è¿Ÿåˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                    setTimeout(() => {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('chat-section').classList.remove('hidden');
                        document.getElementById('chat-section').classList.add('flex');
                        document.getElementById('current-user').textContent = username;
                        document.getElementById('message-input').disabled = false;
                        document.getElementById('send-btn').disabled = false;
                        
                        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                        addSystemMessage(`æ¬¢è¿ ${username} åŠ å…¥èŠå¤©ï¼`);
                        addSystemMessage('ç³»ç»Ÿå·²è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ï¼Œå¯ä»¥å¼€å§‹çœŸæ­£çš„ç”¨æˆ·é—´é€šä¿¡ã€‚');
                        addSystemMessage('æç¤ºï¼šæ‰“å¼€å¦ä¸€ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µï¼Œç”¨ä¸åŒç”¨æˆ·åç™»å½•ï¼Œæµ‹è¯•çœŸæ­£çš„ç”¨æˆ·é—´èŠå¤©ã€‚');
                    }, 500);
                }
            };
            
            socket.on('registered', handleRegistered);
        }
        
        // å‘é€æ¶ˆæ¯
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            const sent = sendMessageToServer(message);
            if (sent) {
                // æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯
                addMessage(currentUser, message, true);
            } else {
                addSystemMessage('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.focus();
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessage(sender, content, isOwn = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${isOwn ? 'own' : 'other'} fade-in`;
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="text-xs opacity-75 mb-1">${sender} Â· ${timeString}</div>
                <div>${content}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-bubble system fade-in';
            
            messageElement.innerHTML = `
                <div class="flex items-center justify-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    <span>${content}</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // é€€å‡ºç™»å½•
        document.getElementById('logout-btn').addEventListener('click', function() {
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog fade-in';
            
            confirmDialog.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-12 h-12 danger-gradient rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-sign-out-alt text-lg"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">ç¡®è®¤é€€å‡º</h3>
                    <p class="text-slate-400 text-sm">ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ</p>
                </div>
                <div class="flex justify-center space-x-3">
                    <button id="cancel-logout" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                        å–æ¶ˆ
                    </button>
                    <button id="confirm-logout" class="danger-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                        ç¡®è®¤é€€å‡º
                    </button>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            document.getElementById('cancel-logout').addEventListener('click', function() {
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirm-logout').addEventListener('click', function() {
                currentUser = null;
                document.getElementById('chat-section').classList.add('hidden');
                document.getElementById('chat-section').classList.remove('flex');
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('message-input').value = '';
                document.getElementById('message-input').disabled = true;
                document.getElementById('send-btn').disabled = true;
                document.getElementById('login-btn').disabled = false;
                
                // æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆä¿ç•™ç¬¬ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                const messagesContainer = document.getElementById('chat-messages');
                while (messagesContainer.children.length > 1) {
                    messagesContainer.removeChild(messagesContainer.lastChild);
                }
                
                addSystemMessage('æ‚¨å·²é€€å‡ºç™»å½•ã€‚');
                document.body.removeChild(confirmDialog);
            });
        });
        
        // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
        document.getElementById('refresh-users-btn').addEventListener('click', function() {
            if (socket && socket.connected) {
                socket.emit('get_online_users', {});
                addSystemMessage('æ­£åœ¨åˆ·æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨...');
            } else {
                addSystemMessage('æœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ— æ³•åˆ·æ–°ç”¨æˆ·åˆ—è¡¨');
            }
        });
        
        // å»ºç«‹P2Pè¿æ¥
        document.getElementById('connect-btn').addEventListener('click', function() {
            const targetUsername = document.getElementById('connect-username').value.trim();
            if (!targetUsername) {
                addSystemMessage('è¯·è¾“å…¥è¦è¿æ¥çš„ç”¨æˆ·å');
                return;
            }
            
            if (targetUsername === currentUser) {
                addSystemMessage('ä¸èƒ½è¿æ¥è‡ªå·±');
                return;
            }
            
            if (socket && socket.connected) {
                socket.emit('p2p_connect', {
                    username: targetUsername,
                    suggested_port: 0
                });
                
                document.getElementById('connection-status').innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>æ­£åœ¨è¿æ¥ ${targetUsername}...`;
                document.getElementById('connection-status').className = 'text-xs text-blue-400 mt-2';
                
                addSystemMessage(`æ­£åœ¨å°è¯•ä¸ ${targetUsername} å»ºç«‹P2Pè¿æ¥...`);
            } else {
                addSystemMessage('æœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ— æ³•å»ºç«‹P2Pè¿æ¥');
            }
        });
        
        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
        function updateOnlineUsersList() {
            const usersList = document.getElementById('online-users-list');
            usersList.innerHTML = '';
            
            if (onlineUsers.length === 0) {
                usersList.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <i class="fas fa-users text-2xl mb-2"></i>
                        <p>æš‚æ— åœ¨çº¿ç”¨æˆ·</p>
                    </div>
                `;
                return;
            }
            
            onlineUsers.forEach(user => {
                if (user.username === currentUser) return; // ä¸æ˜¾ç¤ºè‡ªå·±
                
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center p-3 mb-2 rounded-2xl bg-slate-800/40 border border-slate-700/50 hover:border-blue-500/30 cursor-pointer transition fade-in';
                
                userElement.innerHTML = `
                    <div class="relative">
                        <div class="w-10 h-10 chat-gradient rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-slate-900 rounded-full"></span>
                    </div>
                    <div class="ml-3 flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm">${user.username}</span>
                        </div>
                        <p class="text-xs text-slate-400 truncate">${user.ip || 'æœªçŸ¥IP'}${user.port ? ':' + user.port : ''}</p>
                    </div>
                `;
                
                userElement.addEventListener('click', () => {
                    document.getElementById('connect-username').value = user.username;
                    addSystemMessage(`å·²é€‰æ‹©ç”¨æˆ· ${user.username}ï¼Œç‚¹å‡»"å»ºç«‹P2Pè¿æ¥"æŒ‰é’®å¼€å§‹è¿æ¥`);
                });
                
                usersList.appendChild(userElement);
            });
        }
        
        // åˆ‡æ¢åˆ°P2PèŠå¤©ç•Œé¢
        function switchToP2PChat(targetUser) {
            console.log(`åˆ‡æ¢åˆ°P2PèŠå¤©ç•Œé¢ï¼Œç›®æ ‡ç”¨æˆ·: ${targetUser}`);
            
            // éšè—å…¬å…±èŠå¤©ç•Œé¢
            document.getElementById('chat-section').classList.add('hidden');
            document.getElementById('chat-section').classList.remove('flex');
            
            // åˆ›å»ºP2PèŠå¤©ç•Œé¢
            createP2PChatInterface(targetUser);
        }
        
        // åˆ›å»ºP2PèŠå¤©ç•Œé¢
        function createP2PChatInterface(targetUser) {
            // åˆ›å»ºP2PèŠå¤©å®¹å™¨
            const p2pChatContainer = document.createElement('div');
            p2pChatContainer.id = 'p2p-chat-section';
            p2pChatContainer.className = 'flex-1 flex flex-col';
            
            p2pChatContainer.innerHTML = `
                <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
                <header class="h-20 glass flex items-center justify-between px-8 border-b border-slate-700/50">
                    <div class="flex items-center">
                        <div class="w-10 h-10 chat-gradient rounded-full flex items-center justify-center">
                            <i class="fas fa-user-friends text-sm"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="font-bold text-sm">P2PåŠ å¯†èŠå¤© - ä¸ ${targetUser}</h3>
                            <div class="flex items-center">
                                <span class="online-dot"></span>
                                <span class="text-xs text-green-500">åŠ å¯†è¿æ¥å·²å»ºç«‹</span>
                                <span class="text-xs text-slate-500 ml-2">ç”¨æˆ·: <span id="p2p-current-user">${currentUser}</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="back-to-public-btn" class="glass px-4 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                            <i class="fas fa-arrow-left mr-2"></i>è¿”å›å…¬å…±èŠå¤©
                        </button>
                        <button id="p2p-disconnect-btn" class="danger-gradient px-4 py-2 rounded-xl text-sm hover:opacity-90 transition">
                            <i class="fas fa-unlink mr-2"></i>æ–­å¼€è¿æ¥
                        </button>
                    </div>
                </header>

                <div class="flex-1 flex overflow-hidden">
                    <!-- P2PèŠå¤©åŒºåŸŸ -->
                    <main class="flex-1 flex flex-col">
                        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                        <section class="flex-1 overflow-y-auto p-6 space-y-4" id="p2p-chat-messages">
                            <div class="message-bubble system fade-in">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-shield-alt mr-2"></i>
                                    <span>å·²ä¸ ${targetUser} å»ºç«‹P2PåŠ å¯†è¿æ¥ï¼Œå¼€å§‹ç§å¯†èŠå¤©ï¼</span>
                                </div>
                            </div>
                        </section>

                        <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
                        <footer class="p-6 border-t border-slate-700/50">
                            <div class="glass max-w-4xl mx-auto rounded-2xl flex items-center px-4 py-2 shadow-2xl">
                                <button class="p-2 text-slate-400 hover:text-white transition">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="text" id="p2p-message-input" placeholder="è¾“å…¥ç§å¯†æ¶ˆæ¯..." 
                                       class="flex-1 bg-transparent border-none focus:outline-none px-4 text-sm py-3 text-white placeholder-slate-500">
                                <button class="p-2 text-slate-400 hover:text-white mx-2 transition">
                                    <i class="far fa-smile"></i>
                                </button>
                                <button id="p2p-send-btn" 
                                        class="chat-gradient w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition">
                                    <i class="fas fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </footer>
                    </main>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.querySelector('body').appendChild(p2pChatContainer);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('back-to-public-btn').addEventListener('click', function() {
                document.getElementById('p2p-chat-section').remove();
                document.getElementById('chat-section').classList.remove('hidden');
                document.getElementById('chat-section').classList.add('flex');
                addSystemMessage(`å·²è¿”å›å…¬å…±èŠå¤©å®¤ï¼Œä¸ ${targetUser} çš„P2Pè¿æ¥ä»ç„¶ä¿æŒã€‚`);
            });
            
            document.getElementById('p2p-disconnect-btn').addEventListener('click', function() {
                // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
                const confirmDialog = document.createElement('div');
                confirmDialog.className = 'confirm-dialog fade-in';
                
                confirmDialog.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 danger-gradient rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-unlink text-lg"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">æ–­å¼€P2Pè¿æ¥</h3>
                        <p class="text-slate-400 text-sm">ç¡®å®šè¦æ–­å¼€ä¸ <span class="text-blue-400">${targetUser}</span> çš„P2Pè¿æ¥å—ï¼Ÿ</p>
                    </div>
                    <div class="flex justify-center space-x-3">
                        <button id="cancel-disconnect" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                            å–æ¶ˆ
                        </button>
                        <button id="confirm-disconnect" class="danger-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                            ç¡®è®¤æ–­å¼€
                        </button>
                    </div>
                `;
                
                document.body.appendChild(confirmDialog);
                
                document.getElementById('cancel-disconnect').addEventListener('click', function() {
                    document.body.removeChild(confirmDialog);
                });
                
                document.getElementById('confirm-disconnect').addEventListener('click', function() {
                    // å‘é€æ–­å¼€è¿æ¥é€šçŸ¥ç»™æœåŠ¡å™¨
                    if (socket && socket.connected) {
                        socket.emit('p2p_disconnect', {
                            target: targetUser
                        });
                    }
                    
                    document.getElementById('p2p-chat-section').remove();
                    document.getElementById('chat-section').classList.remove('hidden');
                    document.getElementById('chat-section').classList.add('flex');
                    document.getElementById('connection-status').innerHTML = `<i class="fas fa-plug mr-1"></i>æœªè¿æ¥`;
                    document.getElementById('connection-status').className = 'text-xs text-slate-400 mt-2';
                    addSystemMessage(`å·²æ–­å¼€ä¸ ${targetUser} çš„P2Pè¿æ¥`);
                    document.body.removeChild(confirmDialog);
                });
            });
            
            document.getElementById('p2p-send-btn').addEventListener('click', sendP2PMessage);
            document.getElementById('p2p-message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendP2PMessage();
                }
            });
            
            // åˆå§‹åŒ–P2Pæ¶ˆæ¯è¾“å…¥æ¡†
            document.getElementById('p2p-message-input').focus();
        }
        
        // å‘é€P2Pæ¶ˆæ¯
        function sendP2PMessage() {
            const input = document.getElementById('p2p-message-input');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            // è·å–ç›®æ ‡ç”¨æˆ· - ä»æ ‡é¢˜ä¸­æå–
            const headerElement = document.querySelector('#p2p-chat-section h3.font-bold');
            let targetUser = '';
            if (headerElement) {
                const match = headerElement.textContent.match(/ä¸ (.+?) å»ºç«‹/);
                if (match && match[1]) {
                    targetUser = match[1];
                } else {
                    // å¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼
                    const text = headerElement.textContent;
                    const parts = text.split(' - ä¸ ');
                    if (parts.length > 1) {
                        targetUser = parts[1].trim();
                    }
                }
            }
            
            if (!targetUser) {
                addP2PMessage('ç³»ç»Ÿ', 'æ— æ³•ç¡®å®šèŠå¤©å¯¹è±¡ï¼Œè¯·é‡æ–°è¿æ¥', false);
                return;
            }
            
            console.log(`å‘é€P2Pæ¶ˆæ¯: å½“å‰ç”¨æˆ·=${currentUser}, ç›®æ ‡ç”¨æˆ·=${targetUser}, æ¶ˆæ¯=${message}`);
            
            // å‘é€P2PèŠå¤©æ¶ˆæ¯
            if (socket && socket.connected) {
                const sessionId = `p2p_${currentUser}_${targetUser}`;
                
                // åŠ å¯†æ¶ˆæ¯
                encryptAndSendMessage(message, sessionId, targetUser);
            } else {
                addP2PMessage('ç³»ç»Ÿ', 'å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥', false);
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            input.focus();
        }
        
        // åŠ å¯†å¹¶å‘é€æ¶ˆæ¯
        function encryptAndSendMessage(message, sessionId, targetUser) {
            console.log(`å¼€å§‹åŠ å¯†æ¶ˆæ¯: ${message}`);
            
            // è°ƒç”¨åç«¯APIåŠ å¯†æ¶ˆæ¯
            fetch(API_BASE_URL + '/api/p2p/chat/encrypt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('æ¶ˆæ¯åŠ å¯†æˆåŠŸ:', data);
                    
                    // å‘é€åŠ å¯†æ¶ˆæ¯
                    socket.emit('p2p_chat_message', {
                        session_id: sessionId,
                        content: '[åŠ å¯†æ¶ˆæ¯]',
                        encrypted: true,
                        encrypted_content: data.encrypted_content,
                        session_key: data.session_key,
                        ephemeral: false
                    });
                    
                    console.log(`å·²å‘é€åŠ å¯†P2Pæ¶ˆæ¯: session_id=${sessionId}`);
                    
                    // æ·»åŠ è‡ªå·±çš„æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºä¸ºå·²åŠ å¯†ï¼‰
                    addP2PMessage(currentUser, `ğŸ”’ ${message}`, true);
                    addSystemMessage('æ¶ˆæ¯å·²åŠ å¯†å‘é€');
                } else {
                    console.error('æ¶ˆæ¯åŠ å¯†å¤±è´¥:', data.error);
                    addP2PMessage('ç³»ç»Ÿ', `åŠ å¯†å¤±è´¥: ${data.error}`, false);
                    
                    // å¦‚æœåŠ å¯†å¤±è´¥ï¼Œå‘é€æ˜æ–‡æ¶ˆæ¯
                    socket.emit('p2p_chat_message', {
                        session_id: sessionId,
                        content: message,
                        ephemeral: false
                    });
                    
                    addP2PMessage(currentUser, message, true);
                }
            })
            .catch(error => {
                console.error('åŠ å¯†APIè°ƒç”¨å¤±è´¥:', error);
                addP2PMessage('ç³»ç»Ÿ', `åŠ å¯†APIé”™è¯¯: ${error.message}`, false);
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œå‘é€æ˜æ–‡æ¶ˆæ¯
                socket.emit('p2p_chat_message', {
                    session_id: sessionId,
                    content: message,
                    ephemeral: false
                });
                
                addP2PMessage(currentUser, message, true);
            });
        }
        
        // æ·»åŠ P2Pæ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addP2PMessage(sender, content, isOwn = false) {
            const messagesContainer = document.getElementById('p2p-chat-messages');
            if (!messagesContainer) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${isOwn ? 'own' : 'other'} fade-in`;
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="text-xs opacity-75 mb-1">${sender} Â· ${timeString}</div>
                <div>${content}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ç®¡ç†P2Pä¼šè¯
        let activeP2PSessions = [];
        
        // æ·»åŠ P2Pä¼šè¯
        function addP2PSession(targetUser) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ä¼šè¯
            if (!activeP2PSessions.includes(targetUser)) {
                activeP2PSessions.push(targetUser);
                updateP2PSessionsList();
            }
        }
        
        // ç§»é™¤P2Pä¼šè¯
        function removeP2PSession(targetUser) {
            activeP2PSessions = activeP2PSessions.filter(user => user !== targetUser);
            updateP2PSessionsList();
        }
        
        // æ›´æ–°P2Pä¼šè¯åˆ—è¡¨æ˜¾ç¤º
        function updateP2PSessionsList() {
            const sessionsSection = document.getElementById('p2p-sessions-section');
            const sessionsList = document.getElementById('p2p-sessions-list');
            
            if (activeP2PSessions.length === 0) {
                sessionsSection.classList.add('hidden');
                return;
            }
            
            sessionsSection.classList.remove('hidden');
            sessionsList.innerHTML = '';
            
            activeP2PSessions.forEach(targetUser => {
                const sessionElement = document.createElement('div');
                sessionElement.className = 'flex items-center justify-between p-2 bg-slate-800/20 rounded-lg hover:bg-slate-800/40 transition fade-in';
                
                sessionElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-6 h-6 chat-gradient rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-user-friends text-xs"></i>
                        </div>
                        <span class="text-xs font-medium">${targetUser}</span>
                    </div>
                    <div class="flex space-x-1">
                        <button class="p-1 text-blue-400 hover:text-blue-300 transition" title="é‡æ–°è¿›å…¥èŠå¤©å®¤">
                            <i class="fas fa-sign-in-alt text-xs"></i>
                        </button>
                        <button class="p-1 text-red-400 hover:text-red-300 transition" title="æ–­å¼€è¿æ¥">
                            <i class="fas fa-unlink text-xs"></i>
                        </button>
                    </div>
                `;
                
                // é‡æ–°è¿›å…¥èŠå¤©å®¤æŒ‰é’®
                const reenterBtn = sessionElement.querySelector('button:nth-child(1)');
                reenterBtn.addEventListener('click', function() {
                    reenterP2PChat(targetUser);
                });
                
                // æ–­å¼€è¿æ¥æŒ‰é’®
                const disconnectBtn = sessionElement.querySelector('button:nth-child(2)');
                disconnectBtn.addEventListener('click', function() {
                    disconnectP2PSession(targetUser);
                });
                
                sessionsList.appendChild(sessionElement);
            });
        }
        
        // é‡æ–°è¿›å…¥P2PèŠå¤©å®¤
        function reenterP2PChat(targetUser) {
            console.log(`é‡æ–°è¿›å…¥ä¸ ${targetUser} çš„P2PèŠå¤©å®¤`);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨P2PèŠå¤©ç•Œé¢
            const existingP2PChat = document.getElementById('p2p-chat-section');
            if (existingP2PChat) {
                // å¦‚æœå·²ç»åœ¨P2PèŠå¤©ä¸­ï¼Œå…ˆç§»é™¤å½“å‰ç•Œé¢
                existingP2PChat.remove();
            }
            
            // åˆ‡æ¢åˆ°P2PèŠå¤©ç•Œé¢
            switchToP2PChat(targetUser);
            addSystemMessage(`å·²é‡æ–°è¿›å…¥ä¸ ${targetUser} çš„P2PèŠå¤©å®¤`);
        }
        
        // æ–­å¼€P2Pä¼šè¯
        function disconnectP2PSession(targetUser) {
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog fade-in';
            
            confirmDialog.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-12 h-12 danger-gradient rounded-2xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-unlink text-lg"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">æ–­å¼€P2Pè¿æ¥</h3>
                    <p class="text-slate-400 text-sm">ç¡®å®šè¦æ–­å¼€ä¸ <span class="text-blue-400">${targetUser}</span> çš„P2Pè¿æ¥å—ï¼Ÿ</p>
                </div>
                <div class="flex justify-center space-x-3">
                    <button id="cancel-disconnect-session" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                        å–æ¶ˆ
                    </button>
                    <button id="confirm-disconnect-session" class="danger-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                        ç¡®è®¤æ–­å¼€
                    </button>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            document.getElementById('cancel-disconnect-session').addEventListener('click', function() {
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirm-disconnect-session').addEventListener('click', function() {
                // å‘é€æ–­å¼€è¿æ¥é€šçŸ¥ç»™æœåŠ¡å™¨
                if (socket && socket.connected) {
                    socket.emit('p2p_disconnect', {
                        target: targetUser
                    });
                }
                
                // ç§»é™¤ä¼šè¯
                removeP2PSession(targetUser);
                
                // å¦‚æœå½“å‰åœ¨P2PèŠå¤©ç•Œé¢ï¼Œè¿”å›åˆ°å…¬å…±èŠå¤©
                const p2pChatSection = document.getElementById('p2p-chat-section');
                if (p2pChatSection) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸æ–­å¼€è¿æ¥çš„ç”¨æˆ·èŠå¤©
                    const headerElement = p2pChatSection.querySelector('h3.font-bold');
                    if (headerElement) {
                        const match = headerElement.textContent.match(/ä¸ (.+?) å»ºç«‹/);
                        let currentTargetUser = '';
                        if (match && match[1]) {
                            currentTargetUser = match[1];
                        }
                        
                        if (currentTargetUser === targetUser) {
                            p2pChatSection.remove();
                            document.getElementById('chat-section').classList.remove('hidden');
                            document.getElementById('chat-section').classList.add('flex');
                            document.getElementById('connection-status').innerHTML = `<i class="fas fa-plug mr-1"></i>æœªè¿æ¥`;
                            document.getElementById('connection-status').className = 'text-xs text-slate-400 mt-2';
                        }
                    }
                }
                
                addSystemMessage(`å·²æ–­å¼€ä¸ ${targetUser} çš„P2Pè¿æ¥`);
                document.body.removeChild(confirmDialog);
            });
        }
        
        // ä¿®æ”¹switchToP2PChatå‡½æ•°ï¼Œæ·»åŠ ä¼šè¯ç®¡ç†
        const originalSwitchToP2PChat = switchToP2PChat;
        switchToP2PChat = function(targetUser) {
            console.log(`åˆ‡æ¢åˆ°P2PèŠå¤©ç•Œé¢ï¼Œç›®æ ‡ç”¨æˆ·: ${targetUser}`);
            
            // éšè—å…¬å…±èŠå¤©ç•Œé¢
            document.getElementById('chat-section').classList.add('hidden');
            document.getElementById('chat-section').classList.remove('flex');
            
            // åˆ›å»ºP2PèŠå¤©ç•Œé¢
            createP2PChatInterface(targetUser);
            
            // æ·»åŠ åˆ°ä¼šè¯åˆ—è¡¨
            addP2PSession(targetUser);
        };
        
        // ä¿®æ”¹createP2PChatInterfaceå‡½æ•°ï¼Œæ›´æ–°è¿”å›æŒ‰é’®é€»è¾‘
        const originalCreateP2PChatInterface = createP2PChatInterface;
        createP2PChatInterface = function(targetUser) {
            // åˆ›å»ºP2PèŠå¤©å®¹å™¨
            const p2pChatContainer = document.createElement('div');
            p2pChatContainer.id = 'p2p-chat-section';
            p2pChatContainer.className = 'flex-1 flex flex-col';
            
            p2pChatContainer.innerHTML = `
                <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
                <header class="h-20 glass flex items-center justify-between px-8 border-b border-slate-700/50">
                    <div class="flex items-center">
                        <div class="w-10 h-10 chat-gradient rounded-full flex items-center justify-center">
                            <i class="fas fa-user-friends text-sm"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="font-bold text-sm">P2PåŠ å¯†èŠå¤© - ä¸ ${targetUser}</h3>
                            <div class="flex items-center">
                                <span class="online-dot"></span>
                                <span class="text-xs text-green-500">åŠ å¯†è¿æ¥å·²å»ºç«‹</span>
                                <span class="text-xs text-slate-500 ml-2">ç”¨æˆ·: <span id="p2p-current-user">${currentUser}</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button id="back-to-public-btn" class="glass px-4 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                            <i class="fas fa-arrow-left mr-2"></i>è¿”å›å…¬å…±èŠå¤©
                        </button>
                        <button id="p2p-disconnect-btn" class="danger-gradient px-4 py-2 rounded-xl text-sm hover:opacity-90 transition">
                            <i class="fas fa-unlink mr-2"></i>æ–­å¼€è¿æ¥
                        </button>
                    </div>
                </header>

                <div class="flex-1 flex overflow-hidden">
                    <!-- P2PèŠå¤©åŒºåŸŸ -->
                    <main class="flex-1 flex flex-col">
                        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                        <section class="flex-1 overflow-y-auto p-6 space-y-4" id="p2p-chat-messages">
                            <div class="message-bubble system fade-in">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-shield-alt mr-2"></i>
                                    <span>å·²ä¸ ${targetUser} å»ºç«‹P2PåŠ å¯†è¿æ¥ï¼Œå¼€å§‹ç§å¯†èŠå¤©ï¼</span>
                                </div>
                            </div>
                        </section>

                        <!-- æ¶ˆæ¯è¾“å…¥åŒºåŸŸ -->
                        <footer class="p-6 border-t border-slate-700/50">
                            <div class="glass max-w-4xl mx-auto rounded-2xl flex items-center px-4 py-2 shadow-2xl">
                                <button class="p-2 text-slate-400 hover:text-white transition">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="text" id="p2p-message-input" placeholder="è¾“å…¥ç§å¯†æ¶ˆæ¯..." 
                                       class="flex-1 bg-transparent border-none focus:outline-none px-4 text-sm py-3 text-white placeholder-slate-500">
                                <button class="p-2 text-slate-400 hover:text-white mx-2 transition">
                                    <i class="far fa-smile"></i>
                                </button>
                                <button id="p2p-send-btn" 
                                        class="chat-gradient w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:scale-105 transition">
                                    <i class="fas fa-paper-plane text-xs"></i>
                                </button>
                            </div>
                        </footer>
                    </main>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.querySelector('body').appendChild(p2pChatContainer);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('back-to-public-btn').addEventListener('click', function() {
                document.getElementById('p2p-chat-section').remove();
                document.getElementById('chat-section').classList.remove('hidden');
                document.getElementById('chat-section').classList.add('flex');
                addSystemMessage(`å·²è¿”å›å…¬å…±èŠå¤©å®¤ï¼Œä¸ ${targetUser} çš„P2Pè¿æ¥ä»ç„¶ä¿æŒã€‚`);
            });
            
            document.getElementById('p2p-disconnect-btn').addEventListener('click', function() {
                // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
                const confirmDialog = document.createElement('div');
                confirmDialog.className = 'confirm-dialog fade-in';
                
                confirmDialog.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 danger-gradient rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-unlink text-lg"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">æ–­å¼€P2Pè¿æ¥</h3>
                        <p class="text-slate-400 text-sm">ç¡®å®šè¦æ–­å¼€ä¸ <span class="text-blue-400">${targetUser}</span> çš„P2Pè¿æ¥å—ï¼Ÿ</p>
                    </div>
                    <div class="flex justify-center space-x-3">
                        <button id="cancel-disconnect" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                            å–æ¶ˆ
                        </button>
                        <button id="confirm-disconnect" class="danger-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                            ç¡®è®¤æ–­å¼€
                        </button>
                    </div>
                `;
                
                document.body.appendChild(confirmDialog);
                
                document.getElementById('cancel-disconnect').addEventListener('click', function() {
                    document.body.removeChild(confirmDialog);
                });
                
                document.getElementById('confirm-disconnect').addEventListener('click', function() {
                    // å‘é€æ–­å¼€è¿æ¥é€šçŸ¥ç»™æœåŠ¡å™¨
                    if (socket && socket.connected) {
                        socket.emit('p2p_disconnect', {
                            target: targetUser
                        });
                    }
                    
                    // ç§»é™¤ä¼šè¯
                    removeP2PSession(targetUser);
                    
                    document.getElementById('p2p-chat-section').remove();
                    document.getElementById('chat-section').classList.remove('hidden');
                    document.getElementById('chat-section').classList.add('flex');
                    document.getElementById('connection-status').innerHTML = `<i class="fas fa-plug mr-1"></i>æœªè¿æ¥`;
                    document.getElementById('connection-status').className = 'text-xs text-slate-400 mt-2';
                    addSystemMessage(`å·²æ–­å¼€ä¸ ${targetUser} çš„P2Pè¿æ¥`);
                    document.body.removeChild(confirmDialog);
                });
            });
            
            document.getElementById('p2p-send-btn').addEventListener('click', sendP2PMessage);
            document.getElementById('p2p-message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendP2PMessage();
                }
            });
            
            // åˆå§‹åŒ–P2Pæ¶ˆæ¯è¾“å…¥æ¡†
            document.getElementById('p2p-message-input').focus();
        };
        
        // è¡¨æƒ…é€‰æ‹©å™¨åŠŸèƒ½
        let emojiPickerVisible = false;
        let fileUploadDialogVisible = false;
        
        // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
        function initEmojiPicker() {
            // åˆ›å»ºè¡¨æƒ…é€‰æ‹©å™¨
            const emojiPicker = document.createElement('div');
            emojiPicker.id = 'emoji-picker';
            emojiPicker.className = 'emoji-picker';
            
            // å¸¸ç”¨è¡¨æƒ…
            const commonEmojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 
                                 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
                                 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
                                 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                                 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
                                 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
                                 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯',
                                 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
                                 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ',
                                 'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
                                 'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿',
                                 'ğŸ˜¾'];
            
            // æŒ‰ç±»åˆ«åˆ†ç»„
            const emojiCategories = [
                {
                    title: 'ç¬‘è„¸ä¸äººç‰©',
                    emojis: commonEmojis.slice(0, 30)
                },
                {
                    title: 'æ‰‹åŠ¿ä¸èº«ä½“',
                    emojis: ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘‰', 'ğŸ‘ˆ', 'ğŸ™', 'ğŸ¤', 'ğŸ‘', 'ğŸ™Œ']
                },
                {
                    title: 'åŠ¨ç‰©ä¸è‡ªç„¶',
                    emojis: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ']
                },
                {
                    title: 'é£Ÿç‰©ä¸é¥®æ–™',
                    emojis: ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥']
                },
                {
                    title: 'æ´»åŠ¨',
                    emojis: ['âš½ï¸', 'ğŸ€', 'ğŸˆ', 'âš¾ï¸', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘']
                }
            ];
            
            // æ„å»ºè¡¨æƒ…é€‰æ‹©å™¨å†…å®¹
            emojiPicker.innerHTML = `
                <div class="emoji-picker-content">
                    ${emojiCategories.map(category => `
                        <div class="emoji-category">
                            <div class="emoji-category-title">${category.title}</div>
                            <div class="emoji-grid">
                                ${category.emojis.map(emoji => `
                                    <div class="emoji-item" data-emoji="${emoji}">${emoji}</div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(emojiPicker);
            
            // æ·»åŠ è¡¨æƒ…ç‚¹å‡»äº‹ä»¶
            emojiPicker.addEventListener('click', function(e) {
                if (e.target.classList.contains('emoji-item')) {
                    const emoji = e.target.getAttribute('data-emoji');
                    insertEmoji(emoji);
                    hideEmojiPicker();
                }
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (emojiPickerVisible && !emojiPicker.contains(e.target) && 
                    !e.target.closest('.emoji-btn') && !e.target.classList.contains('far')) {
                    hideEmojiPicker();
                }
            });
        }
        
        // æ˜¾ç¤ºè¡¨æƒ…é€‰æ‹©å™¨
        function showEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            if (!emojiPicker) return;
            
            emojiPicker.classList.add('show');
            emojiPickerVisible = true;
        }
        
        // éšè—è¡¨æƒ…é€‰æ‹©å™¨
        function hideEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            if (!emojiPicker) return;
            
            emojiPicker.classList.remove('show');
            emojiPickerVisible = false;
        }
        
        // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨
        function toggleEmojiPicker() {
            if (emojiPickerVisible) {
                hideEmojiPicker();
            } else {
                showEmojiPicker();
            }
        }
        
        // æ’å…¥è¡¨æƒ…åˆ°è¾“å…¥æ¡†
        function insertEmoji(emoji) {
            const chatSection = document.getElementById('chat-section');
            const p2pChatSection = document.getElementById('p2p-chat-section');
            
            if (p2pChatSection && !p2pChatSection.classList.contains('hidden')) {
                // åœ¨P2PèŠå¤©ä¸­
                const input = document.getElementById('p2p-message-input');
                if (input) {
                    input.value += emoji;
                    input.focus();
                }
            } else if (chatSection && !chatSection.classList.contains('hidden')) {
                // åœ¨å…¬å…±èŠå¤©ä¸­
                const input = document.getElementById('message-input');
                if (input) {
                    input.value += emoji;
                    input.focus();
                }
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function initFileUpload() {
            // åˆ›å»ºæ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†
            const fileUploadDialog = document.createElement('div');
            fileUploadDialog.id = 'file-upload-dialog';
            fileUploadDialog.className = 'file-upload-dialog';
            fileUploadDialog.style.display = 'none';
            
            fileUploadDialog.innerHTML = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 chat-gradient rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-file-upload text-xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">å‘é€æ–‡ä»¶</h3>
                    <p class="text-slate-400 text-sm">é€‰æ‹©è¦å‘é€çš„æ–‡ä»¶ï¼ˆæœ€å¤§10MBï¼‰</p>
                </div>
                
                <div class="file-drop-area" id="file-drop-area">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-3"></i>
                    <p class="text-slate-300 font-medium mb-1">æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                    <p class="text-slate-500 text-sm">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="file-input" class="hidden" multiple>
                </div>
                
                <div class="file-preview" id="file-preview">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name" id="file-name">æœªé€‰æ‹©æ–‡ä»¶</div>
                            <div class="file-size" id="file-size">-</div>
                        </div>
                        <div class="file-remove" id="file-remove">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-3 mt-6">
                    <button id="cancel-upload" class="glass px-5 py-2 rounded-xl text-sm hover:bg-slate-800/50 transition">
                        å–æ¶ˆ
                    </button>
                    <button id="send-file-btn" class="chat-gradient px-5 py-2 rounded-xl text-sm hover:opacity-90 transition">
                        å‘é€æ–‡ä»¶
                    </button>
                </div>
            `;
            
            document.body.appendChild(fileUploadDialog);
            
            // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å˜é‡
            let selectedFile = null;
            
            // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
            const fileDropArea = document.getElementById('file-drop-area');
            const fileInput = document.getElementById('file-input');
            const filePreview = document.getElementById('file-preview');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            const fileRemove = document.getElementById('file-remove');
            
            // ç‚¹å‡»æ–‡ä»¶åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            fileDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾äº‹ä»¶
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.classList.add('dragover');
            });
            
            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.classList.remove('dragover');
            });
            
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelect({ target: { files: e.dataTransfer.files } });
                }
            });
            
            // ç§»é™¤æ–‡ä»¶
            fileRemove.addEventListener('click', () => {
                selectedFile = null;
                fileInput.value = '';
                filePreview.classList.remove('show');
                fileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                fileSize.textContent = '-';
            });
            
            // å–æ¶ˆä¸Šä¼ 
            document.getElementById('cancel-upload').addEventListener('click', hideFileUploadDialog);
            
            // å‘é€æ–‡ä»¶
            document.getElementById('send-file-btn').addEventListener('click', sendSelectedFile);
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­å¯¹è¯æ¡†
            document.addEventListener('click', function(e) {
                if (fileUploadDialogVisible && !fileUploadDialog.contains(e.target) && 
                    !e.target.closest('.file-upload-btn') && !e.target.classList.contains('fa-paperclip')) {
                    hideFileUploadDialog();
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            // åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆå¯ä»¥æ‰©å±•ä¸ºå¤šæ–‡ä»¶ï¼‰
            const file = files[0];
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ10MBé™åˆ¶ï¼‰
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                addSystemMessage('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶');
                return;
            }
            
            selectedFile = file;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileNameElement = document.getElementById('file-name');
            const fileSizeElement = document.getElementById('file-size');
            const filePreview = document.getElementById('file-preview');
            
            fileNameElement.textContent = file.name;
            fileSizeElement.textContent = formatFileSize(file.size);
            filePreview.classList.add('show');
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†
        function showFileUploadDialog() {
            const fileUploadDialog = document.getElementById('file-upload-dialog');
            if (!fileUploadDialog) return;
            
            fileUploadDialog.style.display = 'block';
            fileUploadDialogVisible = true;
            
            // é‡ç½®æ–‡ä»¶é€‰æ‹©
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview').classList.remove('show');
            document.getElementById('file-name').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            document.getElementById('file-size').textContent = '-';
        }
        
        // éšè—æ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†
        function hideFileUploadDialog() {
            const fileUploadDialog = document.getElementById('file-upload-dialog');
            if (!fileUploadDialog) return;
            
            fileUploadDialog.style.display = 'none';
            fileUploadDialogVisible = false;
        }
        
        // å‘é€é€‰ä¸­çš„æ–‡ä»¶
        function sendSelectedFile() {
            if (!selectedFile) {
                addSystemMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            if (!socket || !socket.connected) {
                addSystemMessage('æœªè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œæ— æ³•å‘é€æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = e.target.result;
                const base64Data = fileData.split(',')[1] || fileData;
                
                // è·å–å½“å‰èŠå¤©ç¯å¢ƒ
                const chatSection = document.getElementById('chat-section');
                const p2pChatSection = document.getElementById('p2p-chat-section');
                let target = null;
                let sessionId = null;
                
                if (p2pChatSection && !p2pChatSection.classList.contains('hidden')) {
                    // åœ¨P2PèŠå¤©ä¸­
                    const headerElement = p2pChatSection.querySelector('h3.font-bold');
                    if (headerElement) {
                        // æ ‡é¢˜æ ¼å¼: "P2PåŠ å¯†èŠå¤© - ä¸ ç”¨æˆ·å"
                        const text = headerElement.textContent;
                        const parts = text.split(' - ä¸ ');
                        if (parts.length > 1) {
                            target = parts[1].trim();
                            sessionId = `p2p_${currentUser}_${target}`;
                        } else {
                            // å°è¯•å…¶ä»–æ ¼å¼
                            const match = text.match(/ä¸ (.+?)$/);
                            if (match && match[1]) {
                                target = match[1].trim();
                                sessionId = `p2p_${currentUser}_${target}`;
                            }
                        }
                    }
                }
                
                // å‘é€æ–‡ä»¶
                socket.emit('send_file', {
                    target: target,
                    file_data: base64Data,
                    file_name: selectedFile.name,
                    file_size: selectedFile.size,
                    file_type: selectedFile.type,
                    session_id: sessionId
                });
                
                addSystemMessage(`æ­£åœ¨å‘é€æ–‡ä»¶: ${selectedFile.name}`);
                hideFileUploadDialog();
            };
            
            reader.onerror = function() {
                addSystemMessage('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            // è¯»å–æ–‡ä»¶ä¸ºData URL
            reader.readAsDataURL(selectedFile);
        }
        
        // æ·»åŠ æ–‡ä»¶æ¶ˆæ¯æ˜¾ç¤º
        function addFileMessage(sender, fileInfo, isOwn = false) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${isOwn ? 'own' : 'other'} fade-in`;
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©å›¾æ ‡
            let fileIcon = 'fa-file';
            if (fileInfo.file_type && fileInfo.file_type.startsWith('image/')) {
                fileIcon = 'fa-image';
            } else if (fileInfo.file_type && fileInfo.file_type.startsWith('audio/')) {
                fileIcon = 'fa-file-audio';
            } else if (fileInfo.file_type && fileInfo.file_type.startsWith('video/')) {
                fileIcon = 'fa-file-video';
            } else if (fileInfo.file_type && (fileInfo.file_type.includes('pdf') || fileInfo.file_type.includes('document'))) {
                fileIcon = 'fa-file-pdf';
            }
            
            messageElement.innerHTML = `
                <div class="text-xs opacity-75 mb-1">${sender} Â· ${timeString}</div>
                <div class="file-message">
                    <div class="file-icon">
                        <i class="fas ${fileIcon}"></i>
                    </div>
                    <div class="file-details">
                        <div class="file-name">${fileInfo.file_name}</div>
                        <div class="file-size">${formatFileSize(fileInfo.file_size)}</div>
                    </div>
                    <button class="file-download-btn" onclick="downloadFile('${fileInfo.file_data}', '${fileInfo.file_name}')">
                        ä¸‹è½½
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(base64Data, fileName) {
            try {
                const link = document.createElement('a');
                link.href = `data:application/octet-stream;base64,${base64Data}`;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                addSystemMessage(`æ–‡ä»¶ ${fileName} ä¸‹è½½ä¸­...`);
            } catch (error) {
                console.error('æ–‡ä»¶ä¸‹è½½å¤±è´¥:', error);
                addSystemMessage('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // ç›‘å¬è¡¨æƒ…å’Œæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        function initEmojiAndFileEvents() {
            // å…¬å…±èŠå¤©è¡¨æƒ…æŒ‰é’®
            const publicEmojiBtn = document.querySelector('#chat-section .fa-smile');
            if (publicEmojiBtn) {
                publicEmojiBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleEmojiPicker();
                });
            }
            
            // å…¬å…±èŠå¤©æ–‡ä»¶ä¸Šä¼ æŒ‰é’®
            const publicFileBtn = document.querySelector('#chat-section .fa-paperclip');
            if (publicFileBtn) {
                publicFileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showFileUploadDialog();
                });
            }
            
            // P2PèŠå¤©è¡¨æƒ…æŒ‰é’®
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('fa-smile') || e.target.closest('.fa-smile')) {
                    e.stopPropagation();
                    toggleEmojiPicker();
                }
                
                if (e.target.classList.contains('fa-paperclip') || e.target.closest('.fa-paperclip')) {
                    e.stopPropagation();
                    showFileUploadDialog();
                }
            });
            
            // ç›‘å¬æ–‡ä»¶æ¥æ”¶äº‹ä»¶
            socket.on('file_received', function(data) {
                console.log('æ”¶åˆ°æ–‡ä»¶:', data);
                addFileMessage(data.sender, data, data.sender === currentUser);
                addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.sender} çš„æ–‡ä»¶: ${data.file_name}`);
            });
            
            // ç›‘å¬P2Pæ–‡ä»¶æ¥æ”¶äº‹ä»¶
            socket.on('p2p_file_received', function(data) {
                console.log('æ”¶åˆ°P2Pæ–‡ä»¶:', data);
                
                // æ£€æŸ¥æ˜¯å¦åŠ å¯†æ–‡ä»¶
                if (data.encrypted && data.session_key) {
                    console.log('æ”¶åˆ°åŠ å¯†æ–‡ä»¶ï¼Œå¼€å§‹è§£å¯†...');
                    
                    // è§£å¯†æ–‡ä»¶
                    decryptAndDisplayFile(data);
                } else {
                    // éåŠ å¯†æ–‡ä»¶ï¼Œç›´æ¥æ˜¾ç¤º
                    displayFileMessage(data);
                }
            });
            
            // è§£å¯†å¹¶æ˜¾ç¤ºæ–‡ä»¶
            function decryptAndDisplayFile(data) {
                console.log('è§£å¯†æ–‡ä»¶:', data.file_name);
                
                // è°ƒç”¨è§£å¯†API
                fetch(API_BASE_URL + '/api/p2p/chat/decrypt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_content: data.file_data,
                        session_key: data.session_key
                    })
                })
                .then(response => response.json())
                .then(decryptData => {
                    console.log('æ–‡ä»¶è§£å¯†ç»“æœ:', decryptData);
                    
                    if (decryptData.success) {
                        // è§£å¯†æˆåŠŸï¼Œè·å–è§£å¯†åçš„æ–‡ä»¶æ•°æ®
                        const decryptedFileData = decryptData.decrypted_content;
                        
                        // æ›´æ–°æ•°æ®å¯¹è±¡ï¼Œä½¿ç”¨è§£å¯†åçš„æ•°æ®
                        const decryptedData = {
                            ...data,
                            file_data: decryptedFileData,
                            encrypted: false
                        };
                        
                        // æ˜¾ç¤ºè§£å¯†åçš„æ–‡ä»¶
                        displayFileMessage(decryptedData);
                        addSystemMessage(`æ–‡ä»¶ ${data.file_name} å·²è§£å¯†`);
                    } else {
                        console.error('æ–‡ä»¶è§£å¯†å¤±è´¥:', decryptData.error);
                        
                        // æ˜¾ç¤ºåŠ å¯†æ–‡ä»¶ï¼ˆæ— æ³•è§£å¯†ï¼‰
                        const encryptedData = {
                            ...data,
                            file_name: `ğŸ”’ ${data.file_name} (åŠ å¯†)`,
                            encrypted: true
                        };
                        
                        displayFileMessage(encryptedData);
                        addSystemMessage(`æ–‡ä»¶ ${data.file_name} è§£å¯†å¤±è´¥: ${decryptData.error}`);
                    }
                })
                .catch(error => {
                    console.error('æ–‡ä»¶è§£å¯†APIè°ƒç”¨å¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºåŠ å¯†æ–‡ä»¶ï¼ˆè§£å¯†å¤±è´¥ï¼‰
                    const encryptedData = {
                        ...data,
                        file_name: `ğŸ”’ ${data.file_name} (åŠ å¯†)`,
                        encrypted: true
                    };
                    
                    displayFileMessage(encryptedData);
                    addSystemMessage(`æ–‡ä»¶ ${data.file_name} è§£å¯†APIé”™è¯¯: ${error.message}`);
                });
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
            function displayFileMessage(data) {
                // æ£€æŸ¥æ˜¯å¦åœ¨P2PèŠå¤©ç•Œé¢
                const p2pChatSection = document.getElementById('p2p-chat-section');
                if (p2pChatSection) {
                    // åœ¨P2PèŠå¤©ä¸­æ˜¾ç¤ºæ–‡ä»¶æ¶ˆæ¯
                    const messagesContainer = document.getElementById('p2p-chat-messages');
                    if (messagesContainer) {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message-bubble ${data.from === currentUser ? 'own' : 'other'} fade-in`;
                        
                        const now = new Date();
                        const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                        
                        // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©å›¾æ ‡
                        let fileIcon = 'fa-file';
                        if (data.file_type && data.file_type.startsWith('image/')) {
                            fileIcon = 'fa-image';
                        } else if (data.file_type && data.file_type.startsWith('audio/')) {
                            fileIcon = 'fa-file-audio';
                        } else if (data.file_type && data.file_type.startsWith('video/')) {
                            fileIcon = 'fa-file-video';
                        } else if (data.file_type && (data.file_type.includes('pdf') || data.file_type.includes('document'))) {
                            fileIcon = 'fa-file-pdf';
                        }
                        
                        // å¦‚æœæ˜¯åŠ å¯†æ–‡ä»¶ï¼Œæ·»åŠ åŠ å¯†å›¾æ ‡
                        const fileName = data.encrypted ? `ğŸ”’ ${data.file_name}` : data.file_name;
                        
                        messageElement.innerHTML = `
                            <div class="text-xs opacity-75 mb-1">${data.from} Â· ${timeString}</div>
                            <div class="file-message">
                                <div class="file-icon">
                                    <i class="fas ${fileIcon}"></i>
                                </div>
                                <div class="file-details">
                                    <div class="file-name">${fileName}</div>
                                    <div class="file-size">${formatFileSize(data.file_size)}</div>
                                </div>
                                <button class="file-download-btn" onclick="downloadFile('${data.file_data}', '${data.file_name}')">
                                    ${data.encrypted ? 'åŠ å¯†æ–‡ä»¶' : 'ä¸‹è½½'}
                                </button>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else {
                    // å¦‚æœä¸åœ¨P2PèŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                    const fileStatus = data.encrypted ? 'åŠ å¯†æ–‡ä»¶' : 'æ–‡ä»¶';
                    addSystemMessage(`æ”¶åˆ°æ¥è‡ª ${data.from} çš„${fileStatus}: ${data.file_name}`);
                }
            }
            
            // ç›‘å¬è¡¨æƒ…å‘é€ç¡®è®¤
            socket.on('emoji_sent', function(data) {
                if (data.success) {
                    console.log('è¡¨æƒ…å‘é€æˆåŠŸ');
                } else {
                    addSystemMessage(`è¡¨æƒ…å‘é€å¤±è´¥: ${data.error}`);
                }
            });
            
            // ç›‘å¬æ–‡ä»¶å‘é€ç¡®è®¤
            socket.on('file_sent', function(data) {
                if (data.success) {
                    console.log('æ–‡ä»¶å‘é€æˆåŠŸ');
                } else {
                    addSystemMessage(`æ–‡ä»¶å‘é€å¤±è´¥: ${data.error}`);
                }
            });
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aurora Chat - P2PåŠ å¯†èŠå¤©ç³»ç»Ÿå·²åŠ è½½');
            
            // å¼€å§‹çŠ¶æ€æ£€æŸ¥
            updateStatus();
            setInterval(updateStatus, 10000);
            
            // åˆå§‹ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage('ç³»ç»Ÿå¯åŠ¨å®Œæˆã€‚è¯·ç™»å½•å¼€å§‹çœŸæ­£çš„ç”¨æˆ·é—´é€šä¿¡ã€‚');
            
            // è¿æ¥åˆ°Socket.IOæœåŠ¡å™¨
            connectSocketIO();
            
            // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨å’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            initEmojiPicker();
            initFileUpload();
            
            // åˆå§‹åŒ–è¡¨æƒ…å’Œæ–‡ä»¶äº‹ä»¶ç›‘å¬å™¨
            setTimeout(initEmojiAndFileEvents, 1000);
        });
    </script>
</body>
</html>
